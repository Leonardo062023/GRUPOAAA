<?php
session_start();
require ('../Conexion/conexion.php');
$action = $_POST['action'];   //Capturamos la variable action
if($action == 'registrar') {   //Validamos que el action sea registrar
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Capturamos las variables
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $concepto = $_POST['concepto'];
  $rubro = $_POST['rubro'];
  $fuente = $_POST['fuente'];
  $valor = $_POST['valor'];
  $comprobante = $_POST['comprobante'];
  $tercero = $_POST['tercero'];
  $proyecto = '2147483647';
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Consultamos el id de concepto rubro
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sqlCR = "SELECT id_unico FROM gf_concepto_rubro WHERE concepto = $concepto AND rubro = $rubro";
  $resultCR = $mysqli->query($sqlCR);
  $rowCR = mysqli_fetch_row($resultCR);
  $concepto_R = $rowCR[0];
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Consultamos el id de rubro fuente
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sqlRF = "SELECT id_unico FROM gf_rubro_fuente WHERE rubro = $rubro AND fuente = $fuente";
  $resultRF = $mysqli->query($sqlRF);
  $conteo_RF = $resultRF->num_rows;
  if($conteo_RF < 0){
    $row_RF = mysqli_fetch_row($resultRT);
    $rubro_f = $row_RF[0];
  }else{
    $sqlI = "INSERT INTO gf_rubro_fuente (rubro,fuente) VALUES($rubro,$fuente)";
    $resultI = $mysqli->query($sqlI);
    $sqlRF_2 = "SELECT id_unico FROM gf_rubro_fuente WHERE rubro = $rubro AND fuente = $fuente";
    $result_2 = $mysqli->query($sqlRF_2);
    $row_F2 = mysqli_fetch_row($result_2);
    $rubro_f = $row_F2[0];
  }
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Insertamos el detalles
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sqlInsert = "INSERT INTO gf_detalle_comprobante_pptal (valor,comprobantepptal,rubrofuente,conceptorubro,tercero,proyecto) VALUES($valor,$comprobante,$rubro_f,$concepto_R,$tercero,$proyecto);";
  $resultI = $mysqli->query($sqlInsert);
  echo json_encode($resultI);
}else if($action == 'eliminar'){ //Si action es igual a eliminar
  //Recibimos variable id
  $id = $_POST['id'];
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Consulta para eliminar
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sql = "DELETE FROM gf_detalle_comprobante_pptal WHERE id_unico = $id";
  $result = $mysqli->query($sql);
  echo json_encode ($result);
}else if($action == 'actualizar'){
  //Recibimos variable id
  $id = $_POST['id'];
  //Recibimos variable txtValor
  $txtValor = $_POST['txtValor'];
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Consulta para actualizar
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sql = "UPDATE gf_detalle_comprobante_pptal SET valor = $txtValor WHERE id_unico = $id";
  $result = $mysqli->query($sql);
  echo json_encode($result);
}else if($action == 'update_head'){
  //Recibimos las variables enviadas
  $id = $_POST['id'];
  $tercero = $_POST['tercero'];
  //Validamos si la descripciÃ³n se encentra vacia
  if(!empty($_POST['descripcion'])){
    $descripcion = '"'.$_POST['descripcion'].'"';
  }else{
    $descripcion = 'NULL';
  }
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Consulta para actualizar
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  $sql = "UPDATE gf_comprobante_pptal SET tercero=$tercero,responsable=$tercero,descripcion=$descripcion WHERE id_unico = $id";
  $result = $mysqli->query($sql);
  echo json_encode($result);
}
 ?>
